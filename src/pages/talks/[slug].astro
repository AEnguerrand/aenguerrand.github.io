---
import BaseLayout from "@/layouts/BaseLayout.astro";
import TalksSubnav from "@/components/sections/TalksSubnav.astro";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const talks = await getCollection("talks");
  return talks.map((talk) => ({ params: { slug: talk.slug }, props: { talk } }));
}

const { talk } = Astro.props;
const { Content } = await talk.render();

const formattedDate = new Date(talk.data.date).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const resources = talk.data.resources ?? [];

const videoResource = resources.find((resource) => {
  const label = resource.label.toLowerCase();
  const url = resource.url.toLowerCase();
  return label.includes("video") || label.includes("recording") || url.includes("youtube.com") || url.includes("youtu.be") || url.includes("vimeo.com");
});

const toEmbedUrl = (rawUrl: string) => {
  try {
    const parsed = new URL(rawUrl);
    const host = parsed.hostname.toLowerCase();

    if (host.includes("youtu.be")) {
      const id = parsed.pathname.split("/").filter(Boolean)[0];
      return id ? `https://www.youtube.com/embed/${id}` : null;
    }

    if (host.includes("youtube.com")) {
      const id = parsed.searchParams.get("v");
      if (id) {
        return `https://www.youtube.com/embed/${id}`;
      }

      const shortsMatch = parsed.pathname.match(/^\/shorts\/([^/?#]+)/);
      if (shortsMatch) {
        return `https://www.youtube.com/embed/${shortsMatch[1]}`;
      }

      const embedMatch = parsed.pathname.match(/^\/embed\/([^/?#]+)/);
      if (embedMatch) {
        return `https://www.youtube.com/embed/${embedMatch[1]}`;
      }
    }

    if (host.includes("vimeo.com")) {
      const vimeoMatch = parsed.pathname.match(/\/(\d+)(?:$|\/)/);
      if (vimeoMatch) {
        return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
      }
    }
  } catch {}

  return null;
};

const videoEmbedUrl = videoResource ? toEmbedUrl(videoResource.url) : null;

const sectionLinks: { href: string; label: string }[] = [];
if (videoEmbedUrl) {
  sectionLinks.push({ href: "#video", label: "Video" });
}
sectionLinks.push(
  { href: "#overview", label: "Overview" },
  { href: "#resources", label: "Resources" },
  { href: "#content", label: "Content" }
);

const talkMetadata = [
  { label: "Event", value: talk.data.event },
  { label: "Location", value: talk.data.location },
  { label: "Language", value: talk.data.language?.join(", ") },
  { label: "Format", value: talk.data.sessionType },
].filter((item) => Boolean(item.value));

const hasResources = resources.length > 0;
const baseSectionClass = "mx-auto w-full max-w-5xl scroll-mt-40";
const stackedSectionClass = `${baseSectionClass} mt-6 sm:mt-8`;
const overviewSectionClass = videoEmbedUrl ? stackedSectionClass : baseSectionClass;
---

<BaseLayout title={talk.data.title} description={talk.data.summary}>
  <section class="pt-3 pb-8 sm:pt-6">
    <Card className="border-border/70 bg-card/85 shadow-[0_16px_44px_hsl(var(--foreground)/0.06)]">
      <CardContent className="space-y-5 p-7 sm:p-9">
        <Badge variant="secondary" className="w-fit border border-border/70 bg-secondary/65">
          {formattedDate}
        </Badge>
        <h1 class="text-4xl leading-tight sm:text-5xl">{talk.data.title}</h1>

        {talk.data.summary && <p class="max-w-3xl text-base text-muted-foreground sm:text-lg">{talk.data.summary}</p>}

        {talk.data.author && <p class="text-sm text-muted-foreground">By {talk.data.author.join(", ")}</p>}

        {talk.data.tags && (
          <div class="flex flex-wrap gap-2">
            {talk.data.tags.map((tag) => (
              <span class="rounded-full border border-border/80 bg-secondary/55 px-3 py-1 text-[11px] font-medium tracking-[0.08em] uppercase text-muted-foreground">
                {tag}
              </span>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  </section>

  <TalksSubnav sectionLinks={sectionLinks} showBackHome={false} />

  {videoEmbedUrl && (
    <section id="video" class={baseSectionClass}>
      <Card className="border-border/70 bg-card/90 shadow-[0_14px_36px_hsl(var(--foreground)/0.05)]">
        <CardHeader className="space-y-3">
          <CardTitle className="text-3xl">Watch talk</CardTitle>
          <CardDescription className="max-w-2xl">
            {videoResource?.label ?? "Session recording"}
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div class="overflow-hidden rounded-xl border border-border/70 bg-background/65">
            <iframe
              class="aspect-video w-full"
              src={videoEmbedUrl}
              title={`Video recording for ${talk.data.title}`}
              loading="lazy"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            />
          </div>
          {videoResource && (
            <a
              href={videoResource.url}
              target="_blank"
              rel="noreferrer"
              class="inline-flex rounded-full border border-border/70 bg-card/75 px-4 py-2 text-sm font-medium text-foreground hover:bg-card"
            >
              Open video source
            </a>
          )}
        </CardContent>
      </Card>
    </section>
  )}

  <section id="overview" class={overviewSectionClass}>
    <Card className="border-border/70 bg-card/90 shadow-[0_14px_36px_hsl(var(--foreground)/0.05)]">
      <CardHeader className="space-y-3">
        <CardTitle className="text-3xl">Session overview</CardTitle>
        <CardDescription className="max-w-2xl">
          Standardized details for this talk, including event metadata and reference links.
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {talkMetadata.length > 0 && (
          <dl class="grid gap-3 sm:grid-cols-2">
            {talkMetadata.map((item) => (
              <div class="rounded-lg border border-border/70 bg-background/65 p-3">
                <dt class="text-xs font-semibold tracking-[0.08em] uppercase text-muted-foreground">{item.label}</dt>
                <dd class="mt-1 text-sm text-foreground">{item.value}</dd>
              </div>
            ))}
          </dl>
        )}
      </CardContent>
    </Card>
  </section>

  <section id="resources" class={stackedSectionClass}>
    <Card className="border-border/70 bg-card/90 shadow-[0_14px_36px_hsl(var(--foreground)/0.05)]">
      <CardHeader className="space-y-3">
        <CardTitle className="text-3xl">Resources</CardTitle>
        <CardDescription className="max-w-2xl">
          Links to videos, slides, repositories, and related reading.
        </CardDescription>
      </CardHeader>
      <CardContent>
        {hasResources ? (
          <ul class="space-y-3">
            {resources.map((resource) => (
              <li class="rounded-lg border border-border/70 bg-background/65 p-3">
                <a href={resource.url} target="_blank" rel="noreferrer" class="font-medium text-foreground hover:text-primary">
                  {resource.label}
                </a>
                <p class="mt-1 break-all text-xs text-muted-foreground">{resource.url}</p>
              </li>
            ))}
          </ul>
        ) : (
          <p class="text-sm text-muted-foreground">No specific resources listed for this talk yet.</p>
        )}
      </CardContent>
    </Card>
  </section>

  <section id="content" class={stackedSectionClass}>
    <Card className="border-border/70 bg-card/90 shadow-[0_14px_36px_hsl(var(--foreground)/0.05)]">
      <CardHeader className="space-y-3">
        <CardTitle className="text-3xl">Talk content</CardTitle>
      </CardHeader>
      <CardContent className="prose prose-headings:mt-8 prose-p:leading-relaxed max-w-none pt-2">
        <Content />
      </CardContent>
    </Card>
  </section>

  <div class="mt-8 flex flex-wrap gap-3">
    <Button asChild variant="outline" size="sm">
      <a href="/talks">Back to talks</a>
    </Button>
    <Button asChild variant="outline" size="sm">
      <a href="/">Back home</a>
    </Button>
  </div>
</BaseLayout>
