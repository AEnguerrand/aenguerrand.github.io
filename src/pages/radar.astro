---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { ArrowUpRight, BookOpenText, Mic, Search, Star } from "lucide-react";
import { getCollection } from "astro:content";
import { readFile } from "node:fs/promises";

type StarredDataset = {
  total_repos: number;
  groups: { repos: unknown[] }[];
};

let starsTotal = 0;
let starsListCount = 0;

try {
  const dataPath = new URL("../../public/data/starred-groups.json", import.meta.url);
  const raw = await readFile(dataPath, "utf-8");
  const parsed = JSON.parse(raw) as StarredDataset;
  starsTotal = parsed.total_repos ?? 0;
  starsListCount = parsed.groups.filter((group) => group.repos.length > 0).length;
} catch {
  starsTotal = 0;
  starsListCount = 0;
}

const talks = await getCollection("talks");
const talksCount = talks.length;
const latestTalkTimestamp = talks.reduce((latest, talk) => {
  const timestamp = new Date(talk.data.date).getTime();
  return Number.isFinite(timestamp) ? Math.max(latest, timestamp) : latest;
}, 0);
const latestTalkLabel =
  latestTalkTimestamp > 0
    ? new Date(latestTalkTimestamp).toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      })
    : null;

const cards = [
  {
    key: "stars",
    title: "GitHub Stars",
    label: "Curated repos",
    description:
      "Repositories I find useful, organized by topic.",
    href: "/github-stars",
    cta: "Open stars",
    stats: [`${starsTotal} repos`, `${starsListCount} lists`],
    icon: Star,
  },
  {
    key: "search",
    title: "Search",
    label: "Utility",
    description:
      "Quickly find content from a single entry point.",
    href: "/search",
    cta: "Open search",
    stats: ["Fast lookup", "Cross-page"],
    icon: Search,
  },
] as const;
---

<BaseLayout
  title="Radar"
  description="A single hub for my technical radar: curated repositories and quick site search."
>
  <section class="pt-3 pb-8 sm:pt-6">
    <Card className="border-border/70 bg-card/85 shadow-[0_18px_46px_hsl(var(--foreground)/0.06)]">
      <CardHeader className="space-y-4">
        <Badge variant="secondary" className="w-fit border border-border/70 bg-secondary/65">
          Knowledge Hub
        </Badge>
        <CardTitle className="text-4xl sm:text-5xl">Radar</CardTitle>
        <CardDescription className="max-w-3xl text-base sm:text-lg">
          A central place for what I track and curate: useful repositories and quick access
          to search across the site.
        </CardDescription>
      </CardHeader>
    </Card>
  </section>

  <section class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
    {cards.map((card) => {
      const Icon = card.icon;

      return (
        <Card className="lift-card border-border/70 bg-card/90 shadow-[0_14px_34px_hsl(var(--foreground)/0.05)]">
          <CardHeader className="space-y-3 pb-3">
            <div class="flex items-center justify-between gap-3">
              <span class="rounded-full border border-border/70 bg-secondary/55 px-3 py-1 text-[11px] font-semibold tracking-[0.08em] uppercase text-muted-foreground">
                {card.label}
              </span>
              <Icon className="h-5 w-5 text-primary" />
            </div>
            <CardTitle className="text-3xl">{card.title}</CardTitle>
            <CardDescription>{card.description}</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4 pt-0">
            <div class="flex flex-wrap gap-2">
              {card.stats.map((stat) => (
                <span class="rounded-full border border-border/80 bg-background/70 px-2.5 py-1 text-[11px] font-semibold tracking-[0.08em] uppercase text-muted-foreground">
                  {stat}
                </span>
              ))}
            </div>
            <a
              href={card.href}
              class="inline-flex items-center gap-1.5 text-sm font-semibold text-foreground hover:text-primary"
            >
              {card.cta}
              <ArrowUpRight className="h-4 w-4" />
            </a>
          </CardContent>
        </Card>
      );
    })}
  </section>
</BaseLayout>
