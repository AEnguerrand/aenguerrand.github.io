---
import "../styles/global.css";

const { title = "Enguerrand Allamel", description } = Astro.props;
const pageDescription =
  description ??
  "Staff Cloud Security Engineer focused on secure platforms, resilient systems, and supply chain integrity.";
const pageTitle = title ? `${title} Â· Enguerrand Allamel` : "Enguerrand Allamel";
const siteUrl = Astro.site ?? new URL("https://enguerrand.dev");
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();
const ogImageUrl = new URL("/og-image.jpg", siteUrl).toString();
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={pageDescription} />
    <title>{pageTitle}</title>
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Enguerrand Allamel" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImageUrl} />

    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>
  <body class="min-h-screen bg-background font-sans text-foreground antialiased">
    <div class="relative isolate min-h-screen">
      <div
        aria-hidden="true"
        class="pointer-events-none absolute -top-28 left-[6%] -z-10 h-72 w-72 rounded-full bg-primary/20 blur-3xl"
      />
      <div
        aria-hidden="true"
        class="pointer-events-none absolute top-20 right-[8%] -z-10 h-72 w-72 rounded-full bg-accent/20 blur-3xl"
      />

      <header class="sticky top-4 z-40 mx-auto w-full max-w-6xl px-4 sm:px-6 lg:px-8">
        <nav class="flex flex-wrap items-center justify-between gap-5 rounded-2xl border border-border/70 bg-background/95 px-5 py-3 shadow-[0_10px_28px_hsl(var(--foreground)/0.08)]">
          <a class="text-sm font-semibold tracking-[0.12em] text-foreground uppercase" href="/">Enguerrand Allamel</a>
          <div class="flex flex-wrap items-center gap-2 text-sm text-muted-foreground">
            <a class="nav-pill rounded-full border border-transparent px-3 py-1.5 hover:border-border hover:bg-secondary/70 hover:text-foreground" href="/talks">Talks</a>
            <a class="nav-pill rounded-full border border-transparent px-3 py-1.5 hover:border-border hover:bg-secondary/70 hover:text-foreground" href="/radar">Radar</a>
            <a class="nav-pill rounded-full border border-transparent px-3 py-1.5 hover:border-border hover:bg-secondary/70 hover:text-foreground" href="/resume">Resume</a>
            <a class="nav-pill rounded-full border border-transparent px-3 py-1.5 hover:border-border hover:bg-secondary/70 hover:text-foreground" href="/#contact">Contact</a>
          </div>
        </nav>
      </header>

      <main class="mx-auto w-full max-w-6xl px-4 pb-20 pt-0 sm:px-6 lg:px-8">
        <slot />
      </main>

      <footer class="mx-auto w-full max-w-6xl px-4 pb-10 text-xs text-muted-foreground sm:px-6 lg:px-8">
        <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-border/70 bg-card/80 px-5 py-4">
          <span class="tracking-[0.16em] uppercase">Security. SRE. Platform.</span>
          <div class="flex items-center gap-3">
            <span>Based in Vancouver, BC, Canada ðŸ‡¨ðŸ‡¦</span>
            <a class="nav-pill rounded-full border border-transparent px-3 py-1.5 text-xs hover:border-border hover:bg-secondary/70 hover:text-foreground" href="/privacy">
              Privacy
            </a>
          </div>
        </div>
      </footer>
    </div>
    <script is:inline>
      (() => {
        const isEditableTarget = (target) => {
          if (!(target instanceof HTMLElement)) {
            return false;
          }

          const tag = target.tagName;
          return (
            target.isContentEditable ||
            tag === "INPUT" ||
            tag === "TEXTAREA" ||
            tag === "SELECT"
          );
        };

        const secretSequence = ["arrowleft", "arrowleft", "arrowup", "b", "s"];
        let secretSequenceProgress = 0;

        const launchConfettiBurst = ({
          xRatio = 0.5,
          yRatio = 0.45,
          particleCount = 120,
        } = {}) => {
          const canvas = document.createElement("canvas");
          canvas.setAttribute("aria-hidden", "true");
          canvas.style.position = "fixed";
          canvas.style.inset = "0";
          canvas.style.pointerEvents = "none";
          canvas.style.zIndex = "9999";
          document.body.appendChild(canvas);

          const context = canvas.getContext("2d");
          if (!context) {
            canvas.remove();
            return;
          }

          const dpr = Math.max(1, window.devicePixelRatio || 1);
          const width = window.innerWidth;
          const height = window.innerHeight;
          canvas.width = Math.floor(width * dpr);
          canvas.height = Math.floor(height * dpr);
          context.scale(dpr, dpr);

          const originX = width * xRatio;
          const originY = height * yRatio;
          const colorOffset = Math.random() * 360;
          const particleLifetimeMs = 1400;
          const gravity = 0.18;
          const drag = 0.986;

          const particles = Array.from({ length: particleCount }, () => {
            const angle = Math.random() * Math.PI * 2;
            const speed = 4 + Math.random() * 8;
            return {
              x: originX,
              y: originY,
              vx: Math.cos(angle) * speed,
              vy: Math.sin(angle) * speed - (4 + Math.random() * 3),
              size: 4 + Math.random() * 5,
              rotation: Math.random() * Math.PI * 2,
              rotationVelocity: (Math.random() - 0.5) * 0.35,
              color: `hsl(${(colorOffset + Math.random() * 160) % 360} 95% 58%)`,
            };
          });

          const startTime = performance.now();
          let previousTimestamp = startTime;

          const frame = (timestamp) => {
            const elapsed = timestamp - startTime;
            const normalizedDelta = Math.min(
              2,
              (timestamp - previousTimestamp) / 16.67,
            );
            previousTimestamp = timestamp;

            context.clearRect(0, 0, width, height);

            const fade = 1 - elapsed / particleLifetimeMs;
            for (const particle of particles) {
              particle.vx *= Math.pow(drag, normalizedDelta);
              particle.vy += gravity * normalizedDelta;
              particle.x += particle.vx * normalizedDelta;
              particle.y += particle.vy * normalizedDelta;
              particle.rotation += particle.rotationVelocity * normalizedDelta;

              context.save();
              context.translate(particle.x, particle.y);
              context.rotate(particle.rotation);
              context.globalAlpha = Math.max(0, fade);
              context.fillStyle = particle.color;
              context.fillRect(
                -particle.size / 2,
                -particle.size / 2,
                particle.size,
                particle.size * 0.55,
              );
              context.restore();
            }

            if (elapsed < particleLifetimeMs) {
              window.requestAnimationFrame(frame);
            } else {
              canvas.remove();
            }
          };

          window.requestAnimationFrame(frame);
        };

        const triggerConfetti = () => {
          if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            return;
          }

          launchConfettiBurst();
          window.setTimeout(() => {
            launchConfettiBurst({ xRatio: 0.34, yRatio: 0.56, particleCount: 80 });
          }, 120);
          window.setTimeout(() => {
            launchConfettiBurst({ xRatio: 0.66, yRatio: 0.56, particleCount: 80 });
          }, 230);
        };

        const updateSecretSequence = (event) => {
          if (isEditableTarget(event.target)) {
            secretSequenceProgress = 0;
            return false;
          }

          if (event.ctrlKey || event.metaKey || event.altKey) {
            secretSequenceProgress = 0;
            return false;
          }

          const key = event.key.toLowerCase();
          if (key === secretSequence[secretSequenceProgress]) {
            secretSequenceProgress += 1;

            if (secretSequenceProgress === secretSequence.length) {
              secretSequenceProgress = 0;
              triggerConfetti();
              return true;
            }

            return false;
          }

          secretSequenceProgress = key === secretSequence[0] ? 1 : 0;
          return false;
        };

        window.addEventListener("keydown", (event) => {
          if (updateSecretSequence(event)) {
            event.preventDefault();
            return;
          }

          if (!(event.metaKey || event.ctrlKey)) {
            return;
          }

          if (event.key.toLowerCase() !== "k") {
            return;
          }

          if (isEditableTarget(event.target)) {
            return;
          }

          event.preventDefault();

          const pathname = window.location.pathname.replace(/\/+$/, "");
          if (pathname === "/search") {
            window.dispatchEvent(new CustomEvent("site-search:focus"));
            return;
          }

          const searchUrl = new URL("/search", window.location.origin);
          searchUrl.searchParams.set("focus", "1");
          window.location.assign(searchUrl.toString());
        });
      })();
    </script>
  </body>
</html>
